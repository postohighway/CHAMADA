<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bolão – Painel do Admin (Waldecir)</title>

  <style>
    :root{
      --green:#1b5e20;
      --green2:#2e7d32;
      --yellow:#fff3cd;
      --red:#fde2e1;
      --gray:#f4f6f8;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --orange:#f4b000;
      --btn-blue:#1976d2;
      --btn-red:#d32f2f;
      --btn-gray:#9ca3af;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--gray);
      color: var(--text);
    }
    header{
      background: var(--green2);
      color:#fff;
      padding:14px 16px;
      font-weight:800;
      text-align:center;
      letter-spacing:.3px;
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:14px; }
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      padding:14px;
    }
    .kpi-title{ color:var(--muted); font-weight:700; }
    .kpi-value{ font-size:44px; font-weight:900; margin-top:6px; }
    .section-title{
      font-size:22px;
      font-weight:900;
      margin:16px 0 10px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .row3{
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    label{ display:block; font-weight:800; margin:6px 0 6px; }
    input, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      font-size:16px;
      background:#fff;
      outline:none;
    }
    input:focus, select:focus{ border-color:#86efac; box-shadow:0 0 0 3px rgba(34,197,94,.18); }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .02s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btn-green{ background:var(--green); color:#fff; }
    .btn-blue{ background:var(--btn-blue); color:#fff; }
    .btn-red{ background:var(--btn-red); color:#fff; }
    .btn-gray{ background:var(--btn-gray); color:#fff; }
    .btn-small{ padding:7px 10px; border-radius:9px; font-weight:900; }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:44px;
      padding:7px 10px;
      border-radius:10px;
      font-weight:900;
      border:1px solid transparent;
    }
    .pill-ok{ background:#1f7a2d; color:#fff; }
    .pill-dash{ background:#e5e7eb; color:#111; }
    .help{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
      line-height:1.25;
    }
    .alert{
      background:#fee2e2;
      border:1px solid #fecaca;
      color:#7f1d1d;
      padding:10px 12px;
      border-radius:10px;
      font-weight:800;
      margin-top:10px;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
    }
    thead th{
      background: var(--orange);
      color:#111;
      text-align:left;
      font-weight:900;
      padding:12px 10px;
      font-size:15px;
    }
    tbody td{
      padding:10px 10px;
      border-top:1px solid var(--border);
      vertical-align:middle;
    }
    tbody tr:nth-child(even){ background:#f6fff6; }

    /* STATUS COLORS */
    .tr-nao_vai{ background: var(--red) !important; }
    .tr-prometeu{ background: var(--yellow) !important; }
    .tr-pago{ background: #e7f7ea !important; }

    .name-main{ font-weight:900; }
    .name-sub{ font-size:12px; color:var(--muted); margin-top:2px; }

    .actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    @media (max-width: 900px){
      .grid3{ grid-template-columns:1fr; }
      .row, .row3{ grid-template-columns:1fr; }
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tbody tr{ border-top:1px solid var(--border); }
      tbody td{ border-top:none; display:flex; justify-content:space-between; gap:10px; }
      tbody td::before{
        content: attr(data-label);
        font-weight:900;
        color:var(--muted);
        min-width:140px;
      }
      .actions{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
<header>Bolão – Painel do Admin (Waldecir)</header>

<div class="wrap">
  <div class="grid3">
    <div class="card">
      <div class="kpi-title">Não vai</div>
      <div class="kpi-value" id="kpiNaoVai">0</div>
      <div class="help">status = "nao_vai" (no concurso selecionado)</div>
    </div>
    <div class="card">
      <div class="kpi-title">Pago Waldecir</div>
      <div class="kpi-value" id="kpiWaldecir">0</div>
      <div class="help">pagou_waldecir = TRUE</div>
    </div>
    <div class="card">
      <div class="kpi-title">Pago Lotérica</div>
      <div class="kpi-value" id="kpiLoterica">0</div>
      <div class="help">pagou_loterica = TRUE</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="row">
      <div>
        <div class="section-title" style="margin:0 0 10px;">Concurso</div>
        <label>Selecionar concurso</label>
        <select id="selectConcurso">
          <option value="">Carregando...</option>
        </select>
        <div class="help">Se ficar “Carregando…”: URL/chave errada, bloqueio de rede, ou projeto pausado.</div>
      </div>
      <div>
        <div class="section-title" style="margin:0 0 10px;">Concurso ativo</div>
        <label>&nbsp;</label>
        <input id="concursoAtivo" readonly placeholder="—" />
        <div style="display:flex; gap:10px; margin-top:10px; justify-content:flex-end;">
          <button class="btn btn-gray" id="btnRecarregar">Recarregar</button>
        </div>
      </div>
    </div>

    <div id="errBox" class="alert" style="display:none;"></div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="section-title" style="margin:0 0 10px;">Criar novo concurso</div>

    <div class="row3">
      <div>
        <label>Nome do concurso</label>
        <input id="novoNome" placeholder="Ex.: MEGA DA VIRADA" />
      </div>
      <div>
        <label>Número (opcional)</label>
        <input id="novoNumero" placeholder="Ex.: 3457" inputmode="numeric" />
      </div>
      <div>
        <label>Data</label>
        <input id="novaData" type="date" />
      </div>
    </div>

    <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:10px;">
      <label style="display:flex; gap:10px; align-items:center; margin:0;">
        <input type="checkbox" id="chkAtivo" checked />
        Marcar este como concurso ativo
      </label>

      <label style="display:flex; gap:10px; align-items:center; margin:0;">
        <input type="checkbox" id="chkClonar" checked />
        Clonar participantes do concurso selecionado (se existir)
      </label>
    </div>

    <div style="margin-top:10px;">
      <button class="btn btn-green" id="btnCriar">Criar concurso</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="section-title" style="margin:0 0 10px;">Adicionar participante ao concurso selecionado</div>
    <label>Nome do participante</label>
    <input id="novoParticipante" placeholder="Ex.: João da Silva" />
    <div style="margin-top:10px;">
      <button class="btn btn-green" id="btnAdd">Adicionar</button>
    </div>
    <div class="help">Será adicionado somente no concurso selecionado.</div>
  </div>

  <div class="card" style="margin-top:12px;">
    <div class="section-title" style="margin:0 0 10px;">Participantes do concurso selecionado</div>
    <div class="help" style="margin-bottom:10px;">
      Status muda a cor automaticamente. “Remover” remove <b>apenas deste concurso</b>.
    </div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>Nome</th>
            <th style="width:170px;">Status</th>
            <th style="width:140px;">Pago Waldecir</th>
            <th style="width:140px;">Pago Lotérica</th>
            <th style="width:110px;">Obs</th>
            <th style="width:170px; text-align:right;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" style="padding:14px; color:#6b7280;">Carregando…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ===========================
  // CONFIG (PREENCHA AQUI)
  // ===========================
  const SUPABASE_URL = "COLE_SUA_SUPABASE_URL_AQUI";
  const SUPABASE_KEY = "COLE_SUA_SUPABASE_KEY_AQUI"; // publishable

  // ===========================
  // HELPERS
  // ===========================
  const $ = (id)=>document.getElementById(id);
  const showErr = (msg)=>{
    $("errBox").style.display = "block";
    $("errBox").textContent = msg;
  };
  const clearErr = ()=>{
    $("errBox").style.display = "none";
    $("errBox").textContent = "";
  };

  const validConfig = ()=>{
    if(!SUPABASE_URL || !SUPABASE_KEY) return false;
    if(!SUPABASE_URL.includes("supabase.co")) return false;
    if(SUPABASE_KEY.length < 20) return false;
    return true;
  };

  // Normaliza qualquer coisa que já existe na tabela (Pc/Pe/pago/nao_entrou etc)
  const normalizeStatus = (raw)=>{
    const v = String(raw ?? "").trim();
    const low = v.toLowerCase();

    // "não vai" / "nao_vai" / "nao_entrou"
    if(low === "nao_vai" || low === "não vai" || low === "nao_entrou" || low === "não entrou") return "nao_vai";

    // prometeu / Pc / Pe / Pendente / etc
    if(low === "prometeu" || low === "pc" || low === "pe" || low === "pendente") return "prometeu";

    // pago / pagou
    if(low === "pago" || low === "pagou") return "pago";

    // default
    return "prometeu";
  };

  const statusLabel = (canon)=>{
    if(canon === "nao_vai") return "Não vai";
    if(canon === "pago") return "Pagou";
    return "Prometeu";
  };

  const statusRowClass = (canon)=>{
    if(canon === "nao_vai") return "tr-nao_vai";
    if(canon === "pago") return "tr-pago";
    if(canon === "prometeu") return "tr-prometeu";
    return "";
  };

  const sb = validConfig() ? createClient(SUPABASE_URL, SUPABASE_KEY) : null;

  // ===========================
  // STATE
  // ===========================
  let concursos = [];
  let concursoSelecionadoId = "";
  let participantes = [];

  // ===========================
  // LOAD CONCURSOS
  // ===========================
  async function loadConcursos(){
    clearErr();
    if(!sb){
      showErr("Configure SUPABASE_URL e SUPABASE_KEY no topo do arquivo.");
      $("selectConcurso").innerHTML = `<option value="">(configure URL/Key)</option>`;
      return;
    }

    const { data, error } = await sb
      .from("concursos")
      .select("id,nome,numero,data,ativo,created_at")
      .order("created_at", { ascending:false });

    if(error){
      showErr("Erro ao carregar concursos: " + error.message);
      $("selectConcurso").innerHTML = `<option value="">(erro)</option>`;
      return;
    }

    concursos = data ?? [];

    // preenche select
    const opts = [`<option value="">Selecione…</option>`]
      .concat(concursos.map(c=>{
        const num = (c.numero ?? "");
        const label = num ? `${c.nome} (${num})` : `${c.nome}`;
        return `<option value="${c.id}">${label}</option>`;
      }));
    $("selectConcurso").innerHTML = opts.join("");

    // concurso ativo
    const ativo = concursos.find(c=>c.ativo === true);
    $("concursoAtivo").value = ativo ? (ativo.numero ? `${ativo.nome} (${ativo.numero})` : ativo.nome) : "—";

    // tenta manter seleção anterior, senão pega o ativo, senão o primeiro
    if(concursoSelecionadoId && concursos.some(c=>c.id===concursoSelecionadoId)){
      $("selectConcurso").value = concursoSelecionadoId;
    } else if(ativo){
      concursoSelecionadoId = ativo.id;
      $("selectConcurso").value = ativo.id;
    } else if(concursos[0]){
      concursoSelecionadoId = concursos[0].id;
      $("selectConcurso").value = concursos[0].id;
    }

    if(concursoSelecionadoId){
      await loadParticipantes();
    } else {
      $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">Nenhum concurso cadastrado.</td></tr>`;
      updateKPIs();
    }
  }

  // ===========================
  // LOAD PARTICIPANTES
  // ===========================
  async function loadParticipantes(){
    clearErr();
    if(!concursoSelecionadoId){
      $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">Selecione um concurso.</td></tr>`;
      participantes = [];
      updateKPIs();
      return;
    }

    const { data, error } = await sb
      .from("participantes")
      .select("id,nome,status,pagou_waldecir,pagou_loterica,obs,created_at,concurso_id")
      .eq("concurso_id", concursoSelecionadoId)
      .order("created_at", { ascending:true });

    if(error){
      showErr("Erro ao carregar participantes: " + error.message);
      $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">Erro ao carregar.</td></tr>`;
      participantes = [];
      updateKPIs();
      return;
    }

    participantes = (data ?? []).map(p=>({
      ...p,
      status: normalizeStatus(p.status)
    }));

    renderTabela();
    updateKPIs();
  }

  function updateKPIs(){
    const naoVai = participantes.filter(p => normalizeStatus(p.status) === "nao_vai").length;
    const wal = participantes.filter(p => p.pagou_waldecir === true).length;
    const lot = participantes.filter(p => p.pagou_loterica === true).length;

    $("kpiNaoVai").textContent = naoVai;
    $("kpiWaldecir").textContent = wal;
    $("kpiLoterica").textContent = lot;
  }

  function renderTabela(){
    if(!participantes.length){
      $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">Sem participantes neste concurso.</td></tr>`;
      return;
    }

    $("tbody").innerHTML = participantes.map((p, idx)=>{
      const canon = normalizeStatus(p.status);
      const trClass = statusRowClass(canon);

      const walPill = p.pagou_waldecir ? `<span class="pill pill-ok">OK</span>` : `<span class="pill pill-dash">—</span>`;
      const lotPill = p.pagou_loterica ? `<span class="pill pill-ok">OK</span>` : `<span class="pill pill-dash">—</span>`;

      return `
        <tr class="${trClass}" data-id="${p.id}">
          <td data-label="#" style="font-weight:900;">${idx+1}</td>

          <td data-label="Nome">
            <div class="name-main">${escapeHtml(p.nome ?? "")}</div>
            <div class="name-sub">${p.id}</div>
          </td>

          <td data-label="Status">
            <select data-act="status" data-id="${p.id}">
              <option value="prometeu" ${canon==="prometeu"?"selected":""}>Prometeu</option>
              <option value="pago" ${canon==="pago"?"selected":""}>Pagou</option>
              <option value="nao_vai" ${canon==="nao_vai"?"selected":""}>Não vai</option>
            </select>
          </td>

          <td data-label="Pago Waldecir">
            <div style="display:flex; gap:10px; align-items:center;">
              ${walPill}
              <button class="btn btn-small btn-green" data-act="toggleWal" data-id="${p.id}">
                ${p.pagou_waldecir ? "Desmarcar" : "Marcar"}
              </button>
            </div>
          </td>

          <td data-label="Pago Lotérica">
            <div style="display:flex; gap:10px; align-items:center;">
              ${lotPill}
              <button class="btn btn-small btn-green" data-act="toggleLot" data-id="${p.id}">
                ${p.pagou_loterica ? "Desmarcar" : "Marcar"}
              </button>
            </div>
          </td>

          <td data-label="Obs">
            <input data-act="obs" data-id="${p.id}" value="${escapeAttr(p.obs ?? "")}" placeholder="" />
          </td>

          <td data-label="Ações">
            <div class="actions">
              <button class="btn btn-small btn-blue" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-small btn-red" data-act="remove" data-id="${p.id}">Remover</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){
    return escapeHtml(s).replaceAll("\n"," ");
  }

  // ===========================
  // ACTIONS (EVENT DELEGATION)
  // ===========================
  $("tbody").addEventListener("click", async (ev)=>{
    const btn = ev.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const p = participantes.find(x=>x.id===id);
    if(!p) return;

    try{
      clearErr();

      if(act === "toggleWal"){
        const next = !p.pagou_waldecir;
        const { error } = await sb.from("participantes").update({ pagou_waldecir: next }).eq("id", id);
        if(error) throw error;
        await loadParticipantes();
        return;
      }

      if(act === "toggleLot"){
        const next = !p.pagou_loterica;
        const { error } = await sb.from("participantes").update({ pagou_loterica: next }).eq("id", id);
        if(error) throw error;
        await loadParticipantes();
        return;
      }

      if(act === "edit"){
        const novoNome = prompt("Editar nome do participante:", p.nome ?? "");
        if(novoNome === null) return;
        const nomeFinal = String(novoNome).trim();
        if(!nomeFinal) return;

        const { error } = await sb.from("participantes").update({ nome: nomeFinal }).eq("id", id);
        if(error) throw error;
        await loadParticipantes();
        return;
      }

      if(act === "remove"){
        const ok = confirm("Remover este participante APENAS deste concurso?");
        if(!ok) return;
        const { error } = await sb.from("participantes").delete().eq("id", id);
        if(error) throw error;
        await loadParticipantes();
        return;
      }

    }catch(e){
      showErr("Erro: " + (e?.message || e));
    }
  });

  // status/obs changes
  $("tbody").addEventListener("change", async (ev)=>{
    const target = ev.target;
    const act = target.dataset.act;
    const id = target.dataset.id;
    const p = participantes.find(x=>x.id===id);
    if(!p) return;

    try{
      clearErr();

      if(act === "status"){
        const canon = normalizeStatus(target.value);
        // REGRA: no ADMIN, ao escolher "Pagou", marca pagou_waldecir automaticamente
        const patch = { status: canon };
        if(canon === "pago") patch.pagou_waldecir = true;

        const { error } = await sb.from("participantes").update(patch).eq("id", id);
        if(error) throw error;

        await loadParticipantes();
        return;
      }

    }catch(e){
      showErr("Erro: " + (e?.message || e));
    }
  });

  // obs on blur (menos chamadas)
  $("tbody").addEventListener("blur", async (ev)=>{
    const target = ev.target;
    if(!(target instanceof HTMLInputElement)) return;
    if(target.dataset.act !== "obs") return;

    const id = target.dataset.id;
    const obs = target.value ?? "";

    try{
      clearErr();
      const { error } = await sb.from("participantes").update({ obs }).eq("id", id);
      if(error) throw error;
      // atualiza sem recarregar tudo: simples e seguro recarregar
      await loadParticipantes();
    }catch(e){
      showErr("Erro: " + (e?.message || e));
    }
  }, true);

  // ===========================
  // UI EVENTS
  // ===========================
  $("selectConcurso").addEventListener("change", async ()=>{
    concursoSelecionadoId = $("selectConcurso").value || "";
    await loadParticipantes();
  });

  $("btnRecarregar").addEventListener("click", async ()=>{
    await loadConcursos();
  });

  $("btnCriar").addEventListener("click", async ()=>{
    try{
      clearErr();
      if(!sb) return;

      const nome = String($("novoNome").value || "").trim();
      const numeroRaw = String($("novoNumero").value || "").trim();
      const numero = numeroRaw ? Number(numeroRaw) : null;
      const data = $("novaData").value ? $("novaData").value : null;
      const marcarAtivo = $("chkAtivo").checked;
      const clonar = $("chkClonar").checked;

      if(!nome){
        showErr("Informe o nome do concurso.");
        return;
      }
      if(numeroRaw && Number.isNaN(numero)){
        showErr("Número inválido.");
        return;
      }

      // se marcar como ativo, desativa todos antes
      if(marcarAtivo){
        const { error: e0 } = await sb.from("concursos").update({ ativo:false }).neq("id","00000000-0000-0000-0000-000000000000");
        if(e0) throw e0;
      }

      const payload = {
        nome,
        numero,
        data,
        ativo: marcarAtivo
      };

      const { data: inserted, error } = await sb.from("concursos").insert(payload).select("id").single();
      if(error) throw error;

      const novoConcursoId = inserted.id;

      // clonar participantes do concurso selecionado
      if(clonar && concursoSelecionadoId){
        const base = participantes; // já está carregado do concurso selecionado
        if(base.length){
          const rows = base.map(p=>({
            nome: p.nome,
            status: normalizeStatus(p.status),
            pagou_waldecir: false,
            pagou_loterica: false,
            obs: "",
            concurso_id: novoConcursoId,
            concurso_nome: nome,
            concurso_numero: numero
          }));
          const { error: e2 } = await sb.from("participantes").insert(rows);
          if(e2) throw e2;
        }
      }

      // limpa campos
      $("novoNome").value = "";
      $("novoNumero").value = "";
      $("novaData").value = "";

      // recarrega concursos e seleciona o novo
      await loadConcursos();
      concursoSelecionadoId = novoConcursoId;
      $("selectConcurso").value = novoConcursoId;
      await loadParticipantes();

    }catch(e){
      showErr("Erro ao criar concurso: " + (e?.message || e));
    }
  });

  $("btnAdd").addEventListener("click", async ()=>{
    try{
      clearErr();
      if(!sb) return;
      if(!concursoSelecionadoId){
        showErr("Selecione um concurso antes de adicionar participante.");
        return;
      }

      const nome = String($("novoParticipante").value || "").trim();
      if(!nome){
        showErr("Informe o nome do participante.");
        return;
      }

      const concurso = concursos.find(c=>c.id===concursoSelecionadoId);
      const concurso_nome = concurso?.nome ?? null;
      const concurso_numero = concurso?.numero ?? null;

      const row = {
        nome,
        status: "prometeu",
        pagou_waldecir: false,
        pagou_loterica: false,
        obs: "",
        concurso_id: concursoSelecionadoId,
        concurso_nome,
        concurso_numero
      };

      const { error } = await sb.from("participantes").insert(row);
      if(error) throw error;

      $("novoParticipante").value = "";
      await loadParticipantes();

    }catch(e){
      showErr("Erro ao adicionar participante: " + (e?.message || e));
    }
  });

  // ===========================
  // INIT
  // ===========================
  (async function init(){
    if(!validConfig()){
      showErr("Configure SUPABASE_URL e SUPABASE_KEY no topo do arquivo.");
      $("selectConcurso").innerHTML = `<option value="">(configure URL/Key)</option>`;
      $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">Configure URL/Key.</td></tr>`;
      return;
    }
    await loadConcursos();
  })();

</script>
</body>
</html>
